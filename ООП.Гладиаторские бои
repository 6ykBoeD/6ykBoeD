using System;
using System.Collections.Generic;



namespace CSLight
{
    internal class Program
    {
        static void Main(string[] args)
        {
            Arena arena = new Arena();
            arena.Fight();
        }
    }

    class Fighter
    {
        protected Random _random = new Random();
        public float Armor { get; protected set; }
        public float HP { get; protected set; }
        public float MaxHP { get; protected set; }
        public float Damage { get; protected set; }
        public float FullDamage { get; protected set; }
        public int Mana { get; protected set; }
        public float Rage { get; protected set; }
        public string Name { get; private set; }

        public Fighter(string name, float hp, float damage, float armor, float maxHP, float fullDamage)
        {
            Name = name;
            HP = hp;
            Damage = damage;
            Armor = armor;
            MaxHP = maxHP;
            FullDamage = fullDamage;
        }

        public void TakeDamage(float damage)
        {
            HP -= damage - damage / 100 * Armor;
        }

        public virtual void Attack(Fighter enemyFighter)
        {

        }

        public void ChangeStats(float hp, float damage, float armor, float maxHP,float fullDamage)
        {
            Damage = damage;
            HP = hp;
            Armor = armor;
            MaxHP = maxHP;
            FullDamage = fullDamage;
        }

        public void ShowStats()
        {
            Console.WriteLine($"{Name} -\t Здоровье = {HP}; Урон = {Damage}; Броня = {Armor}");
        }
    }

    class Warrior : Fighter
    {
        private int MultiplierDamage = 4;

        public Warrior(string name, float hp, float damage, float armor, float rage, float maxHP, float fullDamage) : base(name, hp, damage, armor, maxHP, fullDamage)
        {
            Rage = rage;
            if (Rage >= 100)
            {
                Rage = 100;
            }
        }

        public override void Attack(Fighter enemyFighter)
        {
            enemyFighter.TakeDamage(MortalStrike(enemyFighter.HP, enemyFighter.MaxHP));
            Rage += enemyFighter.Damage - enemyFighter.Damage / 100 * Armor;
        }

        public float MortalStrike(float hp,float maxHP)
        {
            float mortalStrikeDamage;

            if (Rage >= 30 && hp <= (maxHP / 2))
            {
                mortalStrikeDamage = Damage * MultiplierDamage;
                Rage -= 30;
                Console.WriteLine("<<<Воин наносит смертоностный удар>>>");
                return mortalStrikeDamage;
            }
            else
            {
                return Damage;
            }
        }
    }

    class Mage : Fighter
    {
        private int _count = 1;

        public Mage(string name, float hp, float damage, float armor, int mana, float maxHP, float fullDamage) : base(name, hp, damage, armor, maxHP, fullDamage)
        {
            Mana = mana;
        }

        public override void Attack(Fighter enemyFighter)
        {
            enemyFighter.TakeDamage(Damage);
            Freeze(enemyFighter);
        }

        public void Freeze(Fighter enemyFighter)
        {
            int manaCost = 50;
            int manaRegeneration = 10;

            if (_count >= 1 && Mana >= manaCost)
            {
                enemyFighter.ChangeStats(enemyFighter.HP, 0, enemyFighter.Armor,enemyFighter.MaxHP, enemyFighter.FullDamage);
                _count = 0;
                Mana -= manaCost;
                Console.WriteLine("<<<Противник заморожен>>>");
            }
            else
            {
                enemyFighter.ChangeStats(enemyFighter.HP, enemyFighter.FullDamage, enemyFighter.Armor,enemyFighter.MaxHP, enemyFighter.FullDamage);
                _count++;
            }

            Mana += manaRegeneration;
        }
    }

    class Druid : Fighter
    {
        private int _shamanismPoint = 3;
        public Druid(string name, float hp, float damage, float armor, float maxHP,float fullDamage) : base(name, hp, damage, armor, maxHP,fullDamage)
        {

        }

        public override void Attack(Fighter enemyFighter)
        {
            Transformation();
            enemyFighter.TakeDamage(Damage);
        }

        public void Transformation()
        {
            int chance = _random.Next(1, 4);
            float increeseDamage = 2 * Damage;
            float increeseHP = 1.5f * HP;
            float increeseMaxHP = 1.5f * MaxHP;
            float increeseArmor = 2* Armor;

            if(_shamanismPoint == 3)
            {
                if(chance == 1)
                {
                    Console.WriteLine("<<<Облик тигра>>>");
                    ChangeStats(HP, increeseDamage, Armor, MaxHP,FullDamage);
                }
                else if(chance == 2)
                {
                    Console.WriteLine("<<<Облик медведя>>>");
                    ChangeStats(increeseHP, Damage, Armor, increeseMaxHP,FullDamage);
                }
                else if(chance == 3)
                {
                    Console.WriteLine("<<<Облик бегемота>>>");
                    ChangeStats(HP, Damage, increeseArmor, MaxHP,FullDamage);
                }
            }
            else if(_shamanismPoint == 0)
            {
                Console.WriteLine("<<<Облик человека>>>");
                ChangeStats(HP,Damage,Armor,MaxHP,FullDamage);
                _shamanismPoint = 4;
            }

            _shamanismPoint--;
        }
    }

    class Thief : Fighter
    {
        private int _evadeShance = 3;
        public Thief(string name, float hp, float damage, float armor, float maxHP,float fullDamage) : base(name, hp, damage, armor, maxHP,fullDamage)
        {

        }

        public override void Attack(Fighter enemyFighter)
        {
            EvadeAttack(enemyFighter);
            enemyFighter.TakeDamage(PoisonAttack());
        }

        public void EvadeAttack(Fighter enemyFighter)
        {
            int chance = _random.Next(1,4);
            int evadeDamage = 0;

            if(chance == _evadeShance)
            {
                enemyFighter.ChangeStats(HP, evadeDamage, Armor,MaxHP,FullDamage);
                Console.WriteLine("<<<Уворот>>>");
            }
            else
            {
                enemyFighter.ChangeStats(_evadeShance, FullDamage, Armor,MaxHP,FullDamage);
            }
        }

        public float PoisonAttack()
        {
            float poisonDamage = 5;
            return Damage + poisonDamage; 
        }
    }

    class Priest : Fighter
    {
        public Priest(string name, float hp, float damage, float armor,int mana, float maxHP, float fullDamage) : base(name, hp, damage, armor, maxHP, fullDamage)
        {
            Mana = mana;
        }

        public override void Attack(Fighter enemyFighter)
        {
            int manaRegeneration = 10;
            InnerFire();
            enemyFighter.TakeDamage(Damage);
            Heal();
            Mana += manaRegeneration;
        }

        public void Heal()
        {
            float healthThreshold = 0.8f;
            int manaCost = 50;
            int heal = 10;

            if (Mana >= manaCost && MaxHP <= healthThreshold*HP)
            {
                HP += heal;
                Mana -= manaCost;
                Console.WriteLine("<<<Лечение>>>");
            }
        }

        public void InnerFire()
        {
            int count = 1;
            int manaCost = 10;
            float lowHP = 0.2f;

            if ( count == 1 && MaxHP <= lowHP * HP)
            {
                Armor += 30;
                Mana -= manaCost;
                Console.WriteLine("<<<Броня повышена>>>");
            }
        }
    }

    class Arena
    {
        private Fighter _firstFighter;
        private Fighter _secondFighter;

        private List<Fighter> _listFighters = new List<Fighter>() {
            new Warrior("Воин",250,20,10,0,250,20),
            new Mage("Маг",150,20,5,250,150,20),
            new Druid("Друид",150,15,10,150,15),
            new Thief("Депутат",125,20,5,125,20),
            new Priest("Прист", 100,15,8,250,100,15)};

        public void Fight()
        {
            int fighterIndex;

            for (int i = 0; i < _listFighters.Count; i++)
            {
                Console.Write(i + 1 + " ");
                _listFighters[i].ShowStats();
            }
            
            Console.WriteLine();
            Console.WriteLine("Выберите первого бойца :");
            fighterIndex = GetNumber();
            _firstFighter = _listFighters[fighterIndex - 1];

            Console.WriteLine("Выберите второго бойца :");
            fighterIndex = GetNumber();
            _secondFighter = _listFighters[fighterIndex - 1];

            while (_firstFighter.HP > 0 && _secondFighter.HP > 0)
            {
                Console.WriteLine();

                _firstFighter.Attack(_secondFighter);
                _secondFighter.Attack(_firstFighter);

                _firstFighter.ShowStats();
                _secondFighter.ShowStats();

                if (_firstFighter.HP <= 0 && _secondFighter.HP <= 0)
                {
                    Console.WriteLine("Оба бойца погибли!");
                }
                else if (_secondFighter.HP <= 0)
                {
                    Console.WriteLine($"Победил {_firstFighter.Name}");
                }
                else if (_firstFighter.HP <= 0)
                {
                    Console.WriteLine($"Победил {_secondFighter.Name}");
                }
            }

            Console.ReadKey();
        }

        int GetNumber()
        {
            bool isTrue = true;

            while (isTrue)
            {
                bool isSuccess = int.TryParse(Console.ReadLine(), out int count);

                if (isSuccess)
                {
                    if ( count <= _listFighters.Count - 1)
                    {
                        return count;
                    }
                    else
                    {
                        Console.WriteLine("Бойца под таким номером нет");
                    }
                    
                }
                else
                {
                    Console.WriteLine("Неверное значение");
                }
            }

            return 0;
        }
    }
}
 
